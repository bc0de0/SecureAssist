# SecureAssist: Enterprise Input Validation Specification (IV-SPEC)
# Version: 3.0.0
# Reference: SA-SEC-IV-001

metadata:
  compliance_mappings:
    owasp: ["A01:2021", "A03:2021"]
    cwe: [20, 89, 639, 79]
  enforcement_strategy: FAIL_FAST
  audit_level: COMPREHENSIVE

rules:
  # -----------------------------------------------------------------------------
  # IV-100: STRUCTURAL & PAYLOAD SHAPING
  # -----------------------------------------------------------------------------
  - id: IV-101
    name: PayloadStrictness
    severity: CRITICAL
    tier: L1_PERIPHERAL
    automation_potential: 100%
    config:
      reject_unknown_properties: true
      fail_on_invalid_enums: true
      max_json_depth: 32
      max_request_size_kb: 5120 # 5MB

  - id: IV-102
    name: StringConstraints
    severity: HIGH
    tier: L1_PERIPHERAL
    automation_potential: 100%
    config:
      default_max_length: 2048
      regex_catalog:
        alphanumeric_safe: "^[a-zA-Z0-9\\s\\-_\\.]*$"
        email_rfc: "^[a-zA-Z0-9+_.-]+@[a-zA-Z0-9.-]+$"
        guid: "^[0-9a-fA-F-]{36}$"

  # -----------------------------------------------------------------------------
  # IV-200: DATA ACCESS & INTEGRITY
  # -----------------------------------------------------------------------------
  - id: IV-201
    name: ParameterizationEnforcement
    severity: CRITICAL
    tier: L2_APPLICATION
    doctrine: "PARAMETERIZED_ONLY"
    audit_requirement: MANDATORY
    note: "Primary defense against SQLi. No dynamic string concatenation permitted."

  - id: IV-202
    name: SecondOrderValidation
    severity: HIGH
    tier: L2_APPLICATION
    requirement: "REVALIDATE_ON_EGRESS"
    scenarios:
      - "Database to AI Prompt"
      - "Database to Email Template"
      - "Database to HTML View"

  # -----------------------------------------------------------------------------
  # IV-300: MULTI-TENANT ISOLATION (STCI)
  # -----------------------------------------------------------------------------
  - id: IV-301
    name: TenantBoundaryAssertion
    severity: CRITICAL
    tier: L2_APPLICATION
    identity_source: "JWT_CLAIM:tenant_id"
    rule: "RESOURCE.TenantId == CONTEXT.TenantId"
    failure_action: BLOCK_AND_SECURITY_ALERT

  # -----------------------------------------------------------------------------
  # IV-400: AVAILABILITY & ANTI-AUTOMATION
  # -----------------------------------------------------------------------------
  - id: IV-401
    name: ServiceAvailabilityGuards
    severity: MEDIUM
    tier: L1_PERIPHERAL
    config:
      global_rate_limit: "1000/min"
      tenant_rate_limit: "100/min"
      max_pagination_size: 100
      max_collection_count: 500

  - id: IV-402
    name: AI_Token_Quota
    severity: MEDIUM
    tier: L3_AI_PROXY
    config:
      max_inbound_tokens: 4096
      max_outbound_tokens: 2048

  # -----------------------------------------------------------------------------
  # IV-500: FILE & ASSET SECURITY
  # -----------------------------------------------------------------------------
  - id: IV-501
    name: FileIntegrityValidation
    severity: HIGH
    tier: L1_PERIPHERAL
    requirements:
      magic_number_verification: true
      guaranteed_unique_filename: true # GUID-based
      allowed_types: 
        - pdf
        - png
        - jpeg
        - json
      av_scanning: required

  # -----------------------------------------------------------------------------
  # IV-600: AI GUARDRAILS
  # -----------------------------------------------------------------------------
  - id: IV-601
    name: LLM_Shield_Inbound
    severity: HIGH
    tier: L3_AI_PROXY
    strategy: HEURISTIC_BLOCKING
    blocked_tokens:
      - "Ignore instructions"
      - "DAN mode"
      - "System prompt override"
    action: REJECT_AND_LOG

  - id: IV-602
    name: LLM_Shield_Outbound
    severity: HIGH
    tier: L3_AI_PROXY
    strategy: PII_REDACTION
    redact_entities: ["SSN", "API_KEYS", "CREDIT_CARD", "PII_NAMED_ENTITY"]
